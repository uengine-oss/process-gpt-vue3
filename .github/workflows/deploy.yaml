name: process-gpt-build-and-deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
      
      - name: Remove node_modules
        run: rm -rf node_modules

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Type check and build
        run: yarn build

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push Docker image to GHCR
        run: |
          IMAGE_TAG=$(echo $GITHUB_SHA | cut -c1-7)
          IMAGE_NAME=ghcr.io/uengine-oss/process-gpt:$IMAGE_TAG

          docker build -t $IMAGE_NAME .
          docker push $IMAGE_NAME

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

      - name: Checkout GitOps repository
        uses: actions/checkout@v3
        with:
          repository: uengine-oss/process-gpt-k8s
          token: ${{ secrets.GITOPS_PAT }}
          path: gitops-repo

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update image tag in GitOps repository
        run: |
          cd gitops-repo
          
          # Update frontend deployment image
          yq eval '.spec.template.spec.containers[0].image = "'$IMAGE_NAME'"' -i frontend-deployment.yaml
          
          # Update any other deployments that use the same image
          # yq eval '.spec.template.spec.containers[0].image = "'$IMAGE_NAME'"' -i frontend-deployment.yaml
          
          echo "Updated image to: $IMAGE_NAME"

      - name: Commit and push changes
        run: |
          cd gitops-repo
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          git commit -m "Update frontend image to $IMAGE_TAG" || exit 0
          git push

      - name: Create deployment comment
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `ðŸš€ **Deployment Started**
              
              **Image:** \`${{ env.IMAGE_NAME }}\`
              **Tag:** \`${{ env.IMAGE_TAG }}\`
              
              ArgoCD will automatically sync the changes from [process-gpt-k8s](https://github.com/uengine-oss/process-gpt-k8s)`
            })
