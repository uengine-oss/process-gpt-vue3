server:
    port: 8088
---
spring:
    profiles: default
    cloud:
        gateway:
            #<<< API Gateway / Routes
            routes:
                - id: litellm
                  uri: http://localhost:4000
                  predicates:
                      - Path=/litellm/**,
                  filters:
                      - RewritePath=/litellm/?(?<segment>.*), /$\{segment}
                - id: execution
                  uri: http://localhost:8000
                  predicates:
                      - Path=/execution/**,
                  filters:
                      - RewritePath=/execution/?(?<segment>.*), /$\{segment}
                - id: autonomous
                  uri: http://localhost:6789
                  predicates:
                      - Path=/autonomous/**,
                  filters:
                      - RewritePath=/autonomous/?(?<segment>.*), /$\{segment}
                - id: memento
                  uri: http://localhost:8005
                  predicates:
                      - Path=/memento/**,
                  filters:
                      - RewritePath=/memento/?(?<segment>.*), /$\{segment}
                - id: voice
                  uri: http://localhost:3000
                  predicates:
                      - Path=/voice/**,
                  filters:
                      - RewritePath=/voice/?(?<segment>.*), /$\{segment}
                - id: frontend
                  uri: http://localhost:5173
                  predicates:
                      - Path=/**
            #>>> API Gateway / Routes
            globalcors:
                corsConfigurations:
                    '[/**]':
                        allowedOrigins:
                            - '*'
                        allowedMethods:
                            - '*'
                        allowedHeaders:
                            - '*'
                        allowCredentials: true
---
spring:
    profiles: docker
    cloud:
        gateway:
            # 기본 타임아웃 설정
            httpclient:
                connect-timeout: 10000
                response-timeout: 60000 # 기본 응답 타임아웃: 60초
                pool:
                    type: ELASTIC
                    max-connections: 100
                    acquire-timeout: 45000

            # 라우트별 설정
            routes:
                # LiteLLM Proxy 라우트
                - id: litellm
                  uri: http://litellm-proxy:4000
                  predicates:
                      - Path=/litellm/**
                  filters:
                      - RewritePath=/litellm/?(?<segment>.*), /$\{segment}
                  order: 1

                # 2. MCP SSE 라우트: 무제한 타임아웃
                - id: mcp-sse
                  uri: http://mcp-proxy-service:80
                  predicates:
                      - Path=/mcp/*/sse/**
                  #   metadata:
                  #       response-timeout: 0 # 무제한
                  filters:
                      - RewritePath=/mcp/?(?<segment>.*), /$\{segment}
                      - AddResponseHeader=X-Accel-Buffering, no
                  order: 2

                # ===================================================================
                # 3. MCP 서버 생성/상태 확인 라우트 (중간 우선순위)
                # ===================================================================
                - id: mcp-control
                  uri: http://mcp-proxy-service:80
                  predicates:
                      # 정규식에서 비캡처 그룹 (?:...) 사용
                      - Path=/mcp/*/{action:(?:create|status)}
                  metadata:
                      response-timeout: 300000 # 300초 = 5분
                  filters:
                      - RewritePath=/mcp/?(?<segment>.*), /$\{segment}
                  order: 3

                # 4. MCP 일반 API 라우트: 기본 타임아웃(60초) 사용
                - id: mcp-api
                  uri: http://mcp-proxy-service:80
                  predicates:
                      - Path=/mcp/**
                  filters:
                      - RewritePath=/mcp/?(?<segment>.*), /$\{segment}
                  order: 4

                # Execution 서비스
                - id: execution
                  uri: http://execution-service:8000
                  predicates:
                      - Path=/execution/**
                  filters:
                      - RewritePath=/execution/?(?<segment>.*), /$\{segment}
                  order: 10

                # Autonomous 서비스
                - id: autonomous
                  uri: http://autonomous-service:6789
                  predicates:
                      - Path=/autonomous/**
                  filters:
                      - RewritePath=/autonomous/?(?<segment>.*), /$\{segment}
                  order: 20

                # Memento 서비스
                - id: memento
                  uri: http://memento-service:8005
                  predicates:
                      - Path=/memento/**
                  filters:
                      - RewritePath=/memento/?(?<segment>.*), /$\{segment}
                  order: 30

                # voice 서비스
                - id: voice
                  uri: http://react-voice-agent-service:3000
                  predicates:
                      - Path=/voice/**
                  filters:
                      - RewritePath=/voice/?(?<segment>.*), /$\{segment}
                  order: 40

                # VNC 라우팅 (Consumer ID 기반)
                - id: vnc-0
                  uri: http://vnc-0.dev.svc.cluster.local:6080
                  predicates:
                      - Path=/vnc/processgpt-browser-server-0/**
                  filters:
                      - RewritePath=/vnc/processgpt-browser-server-0/(?<remaining>.*), /$\{remaining}
                  order: 50

                - id: vnc-1
                  uri: http://vnc-1.dev.svc.cluster.local:6080
                  predicates:
                      - Path=/vnc/processgpt-browser-server-1/**
                  filters:
                      - RewritePath=/vnc/processgpt-browser-server-1/(?<remaining>.*), /$\{remaining}
                  order: 51

                - id: vnc-2
                  uri: http://vnc-2.dev.svc.cluster.local:6080
                  predicates:
                      - Path=/vnc/processgpt-browser-server-2/**
                  filters:
                      - RewritePath=/vnc/processgpt-browser-server-2/(?<remaining>.*), /$\{remaining}
                  order: 52

                - id: vnc-3
                  uri: http://vnc-3.dev.svc.cluster.local:6080
                  predicates:
                      - Path=/vnc/processgpt-browser-server-3/**
                  filters:
                      - RewritePath=/vnc/processgpt-browser-server-3/(?<remaining>.*), /$\{remaining}
                  order: 53

                - id: vnc-4
                  uri: http://vnc-4.dev.svc.cluster.local:6080
                  predicates:
                      - Path=/vnc/processgpt-browser-server-4/**
                  filters:
                      - RewritePath=/vnc/processgpt-browser-server-4/(?<remaining>.*), /$\{remaining}
                  order: 54

                # API 라우팅 (Consumer ID 기반)
                - id: api-0
                  uri: http://processgpt-api-0.dev.svc.cluster.local:5001
                  predicates:
                      - Path=/api/processgpt-browser-server-0/**
                  filters:
                      - RewritePath=/api/processgpt-browser-server-0/(?<remaining>.*), /$\{remaining}
                  order: 60

                - id: api-1
                  uri: http://processgpt-api-1.dev.svc.cluster.local:5001
                  predicates:
                      - Path=/api/processgpt-browser-server-1/**
                  filters:
                      - RewritePath=/api/processgpt-browser-server-1/(?<remaining>.*), /$\{remaining}
                  order: 61

                - id: api-2
                  uri: http://processgpt-api-2.dev.svc.cluster.local:5001
                  predicates:
                      - Path=/api/processgpt-browser-server-2/**
                  filters:
                      - RewritePath=/api/processgpt-browser-server-2/(?<remaining>.*), /$\{remaining}
                  order: 62

                - id: api-3
                  uri: http://processgpt-api-3.dev.svc.cluster.local:5001
                  predicates:
                      - Path=/api/processgpt-browser-server-3/**
                  filters:
                      - RewritePath=/api/processgpt-browser-server-3/(?<remaining>.*), /$\{remaining}
                  order: 63

                - id: api-4
                  uri: http://processgpt-api-4.dev.svc.cluster.local:5001
                  predicates:
                      - Path=/api/processgpt-browser-server-4/**
                  filters:
                      - RewritePath=/api/processgpt-browser-server-4/(?<remaining>.*), /$\{remaining}
                  order: 64

                # Frontend 서비스 (catch-all)
                - id: frontend
                  uri: http://frontend-service:5173
                  predicates:
                      - Path=/**
                  order: 999

            globalcors:
                corsConfigurations:
                    '[/**]':
                        allowedOrigins:
                            - '*'
                        allowedMethods:
                            - '*'
                        allowedHeaders:
                            - '*'
                        allowCredentials: true
                        exposedHeaders:
                            - 'Cache-Control'
                            - 'Connection'
                            - 'Content-Type'
                            - 'Transfer-Encoding'
                            - 'X-Accel-Buffering'
# 로깅 레벨
logging:
    level:
        org.springframework.cloud.gateway: INFO
        reactor.netty.http.client: INFO
        shop.ForwardHostHeaderFilter: INFO
server:
    port: 8080
# Production 환경의 설정은 application-prod.yml 파일에서 관리됩니다.
